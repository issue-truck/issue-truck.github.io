---
title: "제목 xG 해석하기 - 2부"
description: ""
coverImage: "/assets/img/2024-05-16-Part2MakingxGInterpretable_0.png"
date: 2024-05-16 00:50
ogImage: 
  url: /assets/img/2024-05-16-Part2MakingxGInterpretable_0.png
tag: Tech
originalTitle: "Part 2: Making xG Interpretable"
link: "https://medium.com/@karnavpopat/part-2-making-xg-interpretable-f668bb4cf4fa"
---


## 하는 일을 이해하는 것이 중요합니다

저희 블로그 시리즈의 파트 1에서, 우리가 하고자 하는 것을 개요로 설명했습니다: StatsBomb의 오픈 데이터를 사용하여 산업 선도적인 xG 모델을 복제하고 축구 직감을 기반으로 가설을 테스트하는 것입니다. 저희 블로그 시리즈의 파트 2에서는 해석 가능성에 대해 이야기할 것입니다 — 축구 팬들(어느 정도의 팬들이든)이 득점 상황을 평가하는 데 사용하는 휴리스틱은 무엇이며, 이를 어떻게 기능으로 나타낼 수 있을까요? 더 중요한 것은, xGBoosted 분류 트리와 같은 모델을 어떻게 보다 투명하게 만들 수 있는지, 그래서 모델이 어떻게 샷이 골로 번역될 확률에 대한 예측에 결정을 내릴 수 있는지를 확인하는 것입니다.

해석 가능성에는 두 가지 측면이 있습니다 — 첫째, 모델을 축구 팬이 이해할 수 있게 만드는 것, 둘째, 컴퓨터 과학자에게 해석 가능하게 만드는 것입니다. 우리는 첫 번째 측면을 주로 feature engineering을 통해 다룰 것입니다. 이는 데이터 집합을 통해 제공되는 이러한 코드 이상의 의미 있는 통계를 계산함으로써, 모델이 올바른 방향으로 나아가고 있는지 살펴볼 수 있도록 하는 것을 희망합니다. 두 번째 측면은 전통적인 모델 해석 가능성을 통해 다룰 것입니다 — feature selection 방법을 사용하여 어떤 feature가 중요한지 확인하고, 트리가 실제로 중요하게 할당한 feature를 살펴보며, feature의 변동이 목표 변수에 어떻게 영향을 미치는지 연구할 것입니다.

# Feature Engineering



신경망과는 달리, 의사 결정 트리와 xGBoost 트리는 "문제 해결" 능력이 제한되어 있어요. 그들이 도와줄 수 있는 방법 중 하나는 feature engineering입니다. 이를 통해 기록된 데이터에 포함된 정보를 명확하게 만들어줄 수 있어요. 동시에 계산된 휴리스틱을 사용함으로써 트리 모델을 더욱 이해하기 쉽게 만들 수 있어요. 이를 통해 사용자가 판단 기준이 무엇인지 명확히 볼 수 있어요. 4가지 범주에 맞는 feature를 계산하고 사용할 거에요: 위치 기반 통계, 골키퍼 통계, 수비 압력 통계, 그리고 우리의 가설을 바탕으로 한 feature(주로 시간적 패턴).

## 위치 및 거리

위치 기반 feature은 가장 간단하고 직관적이에요. 먼저, x좌표와 y좌표를 하나의 feature로 압축하는 두 가지 변형을 계산해요. "골 거리"는 골 중심부터 슈터의 위치까지의 거리이고, "가장 짧은 거리"는 공이 슈터 위치에서 골까지 이동하는 데 필요한 가장 짧은 거리에요. 필요한 경우 좌표를 함께 고려할 수 있도록 각 좌표(x- 및 y-)를 각각 touchline과 y축으로부터의 거리로 줄였어요.

더 흥미로운 것은 우리의 슈팅 범위 feature인데, 이는 슈터에게 이용 가능한 슈팅 각도 범위를 의미해요. 이것은 중요해요. 왜냐하면 선수가 슈팅하는 각도의 "타이트함"은 informal한 추정으로 보아 득점 가능성에 큰 영향을 미칠 수 있기 때문이에요. 직관적으로, 선수가 타이트한 각도에서 슈팅한다면, 그는 골에 대해 더 작고 나쁜 시야를 가지게 되며, 득점을 위해 매우 정확한 슛을 넣어야 해요. 또한 하나의 수비수가 많은 슛 중 상당 부분을 차단하기가 훨씬 쉬워져요. 따라서 이 휴리스틱은 팬들의 슛에 대한 시각을 모델의 것과 조화시키는 데 매우 중요할 것으로 예상되어요.




![Image](/assets/img/2024-05-16-Part2MakingxGInterpretable_0.png)

# Goalkeepers

개인적으로 저희는 위치 기반 기능과 같은 종류의 계산을 수행했어요. 수비팀 골키퍼에 대한 거의 동일한 계산입니다. 먼저, 좌표를 각각 터치 라인과 y-축으로 표현했습니다. 또한, 슈터와 골키퍼 사이의 절대 거리를 나타내는 기능을 계산했습니다.

![Image](/assets/img/2024-05-16-Part2MakingxGInterpretable_1.png)




# 수비 압박

우리의 기본 모델의 중요한 한계는 골키퍼 이외의 상대 팀 선수를 전혀 고려하지 않았다는 것이었습니다. 즉, 슈팅자에게 가해지는 모든 압박은 촬영 시간에 적용되는 슈팅의 유형과 품질에 큰 영향을 미치지만 이를 포착하지 못했습니다. 이 문제를 해결하기 위한 방법은 StatsBomb의 "프리즈 프레임" 기능을 해석하여 촬영 시간의 모든 관련 선수의 좌표를 포함하는 것입니다.

StatsBomb의 블로그 게시물을 바탕으로, 수비수의 영향력을 측정하는 두 가지 휴리스틱을 계산했습니다. 촬영자 주변 3m 반경 내의 수비수 수(촬영자를 직접 가리거나 압박하는 선수를 나타냄) 및 촬영자와 두 골대 간의 삼각형 내의 수비수 수(슛을 막거나 촬영자를 재촉할 위치에 있는 선수를 나타냄)입니다. 예상대로, 반경이나 삼각형 내의 수비수 수가 늘어날수록 슛의 예상 골성공률이 낮아집니다.

수비 팀의 슈터에 미치는 영향력을 측정하는 직관적인 방법이기 때문에 이것들은 스포팅할 때 수비수가 게임에 얼마나 영향을 줄 수 있는지에 대한 근사치를 제공합니다. 그러나 엄격한 경계(원의 선과 삼각형의 선)로 사물을 측정하기 때문에 심각한 한계가 존재합니다. 이것은 일종의 경위에서 슈터로부터 3.1m 떨어진 경비수가 우리 모델에서 슈터에게 어떤 영향도 미치지 않는다는 것을 의미하는데, 이는 명백히 부정확합니다. 또한, 삼각형 내의 수비수의 위치도 상당히 중요합니다. 삼각형의 가장자리에 있는 수비수는 한쪽 극단 골대 쪽으로 향하는 각도만 커버할 수 있지만, 촬영자 앞 중앙에 있는 수비자는 매우 큰 영향력을 가질 수 있습니다.




<img src="/assets/img/2024-05-16-Part2MakingxGInterpretable_2.png" />

수비수를 나타내기 위해 한 점을 사용하는 것으로 인한 문제를 해결하기 위해, 우리는 가우시안 함수를 사용하여 수비수들이 경기장에 "영향"을 미치는 것으로 나타낼 수 있습니다. 우리는 각 지점에 "영향력 값"을 할당할 수 있으며, 이는 경기장의 모든 지점에서 선수들의 영향의 합을 나타냅니다 (슈터의 삼각형의 경우) 또는 슈터의 위치에서의 영향 (반지름의 경우). 우리는 이제 슛 위치와 두 골대 위치 사이의 삼각형 및 슈터 주변의 반지름에서 모든 상대팀 선수들이 가진 영향력 양을 계산할 수 있습니다. 이러한 매끄럽게 하는 것은 슈터 주변 반경 밖에 있는 수비수들도 게임에 일정한 영향을 미칠 수 있도록 합니다.

<img src="/assets/img/2024-05-16-Part2MakingxGInterpretable_3.png" />

<img src="/assets/img/2024-05-16-Part2MakingxGInterpretable_4.png" />




# 우리의 가설에 기반한 기능들

우리의 가설을 테스트하고, 슛이 골이 될 가능성의 변동성을 더 많이 포착할 수 있는지 확인하기 위해 추가 기능을 계산할 것입니다. 이러한 대부분의 기능들은 경기 시간을 기반으로 합니다.

이러한 시간을 기반으로 한 가장 간단한 기능 중 하나는 슛이 추가 시간에 있는지 여부입니다. "경기 진행 단계(phase of play)"를 포착하기 위해 각 슛의 타임스탬프에 대해 과거 1분 동안 동일한 팀이 얼마나 많은 슛을 날렸는지와 지난 15분 동안 얼마나 많은 슛을 날렸는지 계산할 것입니다. 이 기능은 그렇게 간단하게 계산되지는 않지만, 한 팀에 경기의 균형이 얼마나 기울었는지를 볼 수 있게 해주는 중요한 기능입니다. 마지막으로, "도박꾼의 오류"를 테스트하여, 더 많은 슛을 날린 팀이 결국 골을 "맞을 것"으로 여긴다는 주장에 대해, 마지막 골 이후에 얼마나 많은 슛이 날렸는지 추적할 것입니다.

또한, 각 슛의 시점에서 "경기 상태(game state)"를 추적하고 싶습니다: 어느 팀이 선두를 달리고 있었고, 얼마나 많이 이기고 있었는지? 각각을 별도로 추적하기 위해, 먼저 선두에 있는 팀을 나타내는 삼상 필드 표시기와 그들이 우위를 가지고 있을 때의 득점(있는 경우) 수를 나타내는 다른 변수를 계산할 것입니다.



마지막으로, 차지했던 피치 면을 추적해 해당 발로 슛이 나갔는지 확인합니다. 이는 그 샷이 발에 유리한 피치 면에서 쏘였는지 여부를 이진식으로 나타냅니다.

계산된 모든 특징들이 제공하는 이유는 팬이 샷의 성공 가능성을 판단할 때 사용하는 기본적인 축구 직관을 포착하기 위함입니다. 이러한 특징들을 사용하여 데이터셋으로 나타나는 동일한 정보를 포착하고, 아마도 더 나은 방식으로 대표하기를 희망함으로써, 트리 기반 모델을 훨씬 더 설명 가능하게 만들고 싶습니다.

# 특성 선택

물론 해석 가능성을 높이는 공식적인 방법들도 있습니다. 우리가 조사한 문헌 중 일부는 중요한 특성 선택 및 일반화 가법 모델을 사용하여 해석 가능성을 높였으며, 저희는 후자가 성과가 크지 않다는 점을 발견하였지만, 이 방법은 상당한 장점을 지니고 있습니다.



기능 선택은 모델 학습에서 중요한 역할을 합니다. 이는 데이터셋에서 노이즈를 제거하고 모델을 보다 해석 가능하게 만들어 주어 고려해야 하는 요소의 수를 줄입니다.

스키런에서 제공되는 두 가지 기능 선택 방법, SelectFromModel 및 PermutationFeatureImportance을 실험한 후에 상호 정보 분류로 결정을 내렸습니다. 이러한 기능 선택 방법을 통해 모델 예측에 가장 영향을 주는 피쳐들을 식별하고, 이러한 피쳐들의 중요성이 서로 다른 요소들 간에 변화하는지 확인할 수 있었습니다.

SelectFromModel (SFM)은 학습된 선형 모델의 가중치와 계수를 사용하여 가장 중요한 n개의 기능을 선택합니다. 우리는 LassoCV 모델을 학습시켰는데, 이는 L1과 L2 정규화의 조합을 사용하여 가장 중요한 기능을 선택합니다. SFM에 의해 모든 슛들에 대해 선택된 상위 5개의 기능은 두 개의 계산된 수비수 압박 피쳐, 두 개의 골키퍼 피쳐 및 슛이 1:1 상황에서 발생했는지 여부였습니다. 이는 우리가 중요한 정보를 포착했다는 좋은 확인이 되었지만, 가장 중요한 정보가 모두 포지셔널로 보여지는 것을 의미합니다. 그러나 SFM은 xG 계산에 사용한 의사결정 트리 모델을 사용하지 않고, 회귀 분석만 사용하므로 이는 피쳐와 목표 변수 간의 관계를 정확히 대변하지 못할 수 있습니다. 또한 어떤 피쳐가 얼마나 중요한지 정량화하지 않고 랭킹만 제공합니다.

이러한 문제를 해결하기 위해 우리는 순열 피쳐 중요도 (PFI)를 사용했는데, 이는 피쳐 중요성에 대해 보다 섬세한 이해를 제공합니다. 이 방법은 각 피쳐의 값을 무작위로 치환하고 의사결정 트리의 성능 변화를 측정함으로써 작동합니다. 가장 큰 변화를 일으키는 피쳐가 가장 중요한 것으로 간주됩니다. PFI는 또한 성능 변화를 설명하는 값을 제공하며, 이를 통해 피쳐의 중요성을 더 잘 이해할 수 있습니다. PFI는 위치 기반 및 수비 피쳐를 선택했으며, 우리가 리그 간에 플레이 스타일이 다르다는 가설을 지지할 때 핵심적인 요소임을 보여주었습니다. 이는 각 리그의 팀이 서로 다른 플레이 스타일과 전술을 채택하고 있다는 우리의 가설을 뒷받침합니다.



결국, 우리는 상호 정보 분류를 사용하여 각 특징의 중요성을 측정했습니다. 이는 특정 특징이 목표 변수의 변동성 중 얼마만큼을 설명하는지를 나타내는 점수를 제공해줍니다. 이것은 해석 가능성을 위한 중요한 도구입니다. 상호 정보는 다른 두 분류기와 같은 순위를 주었는데, 더 많은 정보를 제공하고 있습니다 - 가장 중요한 특징인 슈터와 골키퍼 사이의 거리, 슈팅 각의 범위, 그리고 골로부터의 최상의 거리는 골 득점률의 변동성 중 5%를 차지합니다.

# 특징 의존성 해석

이해하기 위한 또 다른 중요한 방법은 특징 범위의 값 변화가 목표 변수에 어떤 영향을 미치는지, 즉 머신 러닝 모델의 예측 결과에 대한 한 또는 두 특징의 주효과가 무엇인지를 측정하는 능력입니다. 부분 의존성 플롯은 목표와 특징 간의 관계가 선형적인지, 단조적인지, 아니면 더 복잡한지를 보여줄 수 있습니다.

예를 들어, 우리의 가설에 기반한 특징들 중 몇 가지를 살펴보겠습니다. 우리의 가장 직관적인 특징 중 두 가지를 살펴보죠 - 골키퍼와의 거리, 그리고 슈터 삼각형 내 수비수의 수.



![이미지](/assets/img/2024-05-16-Part2MakingxGInterpretable_5.png)

골키퍼와의 거리가 가장 영향을 많이 미치는 것을 알 수 있습니다. 슈터가 꽤 가까울 때 영향을 가장 많이 미치며, 그 후에 감소합니다. 한편, 삼각형 안의 수비수의 영향은 0일 때 가장 크며(이는 큰 득점 기회를 나타냅니다), 추가 수비수는 영향력이 낮아지는 것을 보여줍니다. 수비수 플롯도 문제점을 잘 나타냅니다 - 그 단위가 이산적이며 임계치에서 급격히 하강합니다.

# 트리로 하는 결정

마지막으로 모델을 해석 가능하게 만드는 가장 간단하지만 중요한 방법은 해석 가능한 모델을 사용하고 그것을 해석하는 것입니다. 의사결정 트리는 각 매개변수를 기반으로 상황을 분석하는 이점이 있습니다. Python의 dtreeviz 라이브러리를 사용하면 트리를 시각적으로 표현하고 어떤 기준이 어떤 기능에 설정되어 있는지 확인할 수 있습니다. 이는 각 특성의 중요성을 확인하는 매우 직관적이면서도 단순한 방법을 제공합니다.




![Image](/assets/img/2024-05-16-Part2MakingxGInterpretable_6.png)
